#!/usr/bin/env bash

# Config
HIST_FILE="$HOME/.local/share/zathura/history"
THUMBNAIL_DIR="$HOME/.cache/pdf_thumbnails"
ROFI_THEME="$HOME/.config/rofi/pdfs.rasi"

# Ensure thumbnail directory exists
mkdir -p "$THUMBNAIL_DIR"

# Get session type (X11 or Wayland)
SESSION_TYPE="${XDG_SESSION_TYPE:-x11}"

# Get recent PDFs from Zathura history (more robust parsing)
get_recent_pdfs() {
  [ -f "$HIST_FILE" ] &&
    grep -oP '\[\K[^]]*\.pdf(?=\])' "$HIST_FILE" 2>/dev/null |
    awk '!seen[$0]++' # Remove duplicates without sorting
}

# Get all PDFs using fd (fast) with fallback to find
get_all_pdfs() {
  if command -v fd >/dev/null; then
    fd --type=file --extension=pdf . 2>/dev/null
  else
    find ~/ -type f -name "*.pdf" 2>/dev/null
  fi
}

# Generate thumbnail for a PDF (cached)
generate_thumbnail() {
  local pdf="$1"
  local hash=$(echo -n "$pdf" | md5sum | awk '{print $1}')
  local thumb="$THUMBNAIL_DIR/$hash.png"

  if [[ ! -f "$thumb" ]]; then
    # Use pdftoppm (fast) or convert (fallback)
    if command -v pdftoppm >/dev/null; then
      pdftoppm -png -singlefile -scale-to-x 600 -scale-to-y 640 "$pdf" "$THUMBNAIL_DIR/$hash" 2>/dev/null
    elif command -v convert >/dev/null; then
      convert -thumbnail 258x200 "$pdf[0]" "$thumb" 2>/dev/null
    fi
  fi
  echo "$thumb"
}

# Main selection logic
main() {
  local RECENT=$(get_recent_pdfs)
  local ALL=$(get_all_pdfs)
  local ALL_UNIQ=$(echo -e "$RECENT\n$ALL" | awk '!seen[$0]++') # Merge without sorting

  # Rofi with thumbnails (X11)
  local SEL=$(
    while IFS= read -r pdf; do
      [ -f "$pdf" ] || continue
      thumb=$(generate_thumbnail "$pdf")
      echo -e "$pdf\0icon\x1f$thumb"
    done <<<"$ALL_UNIQ" |
      rofi -dmenu -sorting-method fzf -show-icons -theme "$ROFI_THEME" -p "PDFs: "
  )
  # # Fuzzel (Wayland)
  # local SEL=$(echo "$ALL_UNIQ" | fuzzel \
  #   -b 232136ff -t e0def4ff -s c4a7e7ff -S 232136ff \
  #   -d --match-mode=exact -w 100 -l 10 -p 'PDFs: ')

  # Open selected PDF
  if [ -n "$SEL" ] && [ -f "$SEL" ]; then
    zathura "$SEL" &
  fi
}

main

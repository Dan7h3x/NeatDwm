#!/bin/bash

# Userscript for qutebrowser to open quickmarks and bookmarks via dmenu.
# If the input text isn't a URL, it will be searched using the default search engine.

# Paths to quickmarks and bookmarks files
QUICKMARKS_PATH="$HOME/.config/qutebrowser/quickmarks"
BOOKMARKS_PATH="$HOME/.config/qutebrowser/bookmarks/urls"

# Check if the files exist
if [ ! -f "$QUICKMARKS_PATH" ] && [ ! -f "$BOOKMARKS_PATH" ]; then
    echo "error: No quickmarks or bookmarks found." >&2
    exit 1
fi

# Parse quickmarks (format: <key> <url> [title])
parse_quickmarks() {
    if [ -f "$QUICKMARKS_PATH" ]; then
        while read -r line; do
            # Skip empty lines and comments
            if [[ -z "$line" || "$line" =~ ^# ]]; then
                continue
            fi
            # Extract key, URL, and optional title
            key=$(echo "$line" | awk '{print $1}')
            url=$(echo "$line" | awk '{print $2}')
            title=$(echo "$line" | cut -d' ' -f3-)
            if [ -n "$title" ]; then
                echo -e "$key\t$url\t$title"
            else
                echo -e "$key\t$url\t$url"
            fi
        done < "$QUICKMARKS_PATH"
    fi
}

# Parse bookmarks (format: <url> [title])
parse_bookmarks() {
    if [ -f "$BOOKMARKS_PATH" ]; then
        while read -r line; do
            # Skip empty lines and comments
            if [[ -z "$line" || "$line" =~ ^# ]]; then
                continue
            fi
            url=$(echo "$line" | awk '{print $1}')
            title=$(echo "$line" | cut -d' ' -f2-)
            if [ -n "$title" ]; then
                echo -e "$url\t$url\t$title"
            else
                echo -e "$url\t$url\t$url"
            fi
        done < "$BOOKMARKS_PATH"
    fi
}

# Combine quickmarks and bookmarks into a single list
COMBINED_LIST=$(parse_quickmarks && parse_bookmarks)

# Display the list in dmenu and get the user's selection
SELECTION=$(echo "$COMBINED_LIST" | dmenu -l 20 -p "Bookmarks:" | cut -f2)  # Extract URL from the tab-separated output

# If no selection, exit
if [ -z "$SELECTION" ]; then
    exit 0
fi

# Check if the selection is a URL
if [[ "$SELECTION" =~ ^(https?|ftp):// ]] || [[ "$SELECTION" =~ ^[a-zA-Z0-9]+\.[a-zA-Z]{2,}$ ]]; then
    # Open the URL directly
    echo "open $SELECTION"
else
    # Search the text using the default search engine
    echo "open $SELECTION"
fi
